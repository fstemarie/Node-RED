[{"id":"2dbe54a8.332f04","type":"tab","label":"/r/GamesDeal","disabled":false,"info":""},{"id":"1c9d8fd6.7a925","type":"tab","label":"Sous Ecoute","disabled":false,"info":""},{"id":"e3f7555d.d32fa","type":"sftp","z":"","host":"raktar.local","port":"22","tryKeyboard":false,"key":"","keyname":"id_rsa_nodered_raktar","algorithms_kex":"ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha1","algorithms_cipher":"aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm,aes128-gcm@openssh.com,aes256-gcm,aes256-gcm@openssh.com","algorithms_serverHostKey":"ssh-rsa,ecdsa-sha2-nistp256,ecdsa-sha2-nistp384,ecdsa-sha2-nistp521","algorithms_hmac":"hmac-sha2-256,hmac-sha2-512,hmac-sha1","algorithms_compress":"none,zlib@openssh.com,zlib"},{"id":"32c19c52.906784","type":"xml","z":"1c9d8fd6.7a925","name":"","property":"payload","attr":"","chr":"","x":510,"y":100,"wires":[["96cde5c.f3cc698"]]},{"id":"565f92.812bb87","type":"http request","z":"1c9d8fd6.7a925","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"https://baladoquebec.ca/sousecoute/rss","tls":"","persist":false,"proxy":"","authType":"","x":330,"y":100,"wires":[["32c19c52.906784"]]},{"id":"a4b8c5bc.5f1d2","type":"inject","z":"1c9d8fd6.7a925","name":"Trigger","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":100,"wires":[["565f92.812bb87"]]},{"id":"8e53928c.d9418","type":"split","z":"1c9d8fd6.7a925","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":190,"y":160,"wires":[["4366e719.59524"]]},{"id":"96cde5c.f3cc698","type":"change","z":"1c9d8fd6.7a925","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"old","tot":"msg"},{"t":"move","p":"old.rss.channel[0].item","pt":"msg","to":"payload","tot":"msg"},{"t":"delete","p":"old","pt":"msg"},{"t":"delete","p":"topic","pt":"msg"},{"t":"delete","p":"statusCode","pt":"msg"},{"t":"delete","p":"headers","pt":"msg"},{"t":"delete","p":"responseUrl","pt":"msg"},{"t":"delete","p":"redirectList","pt":"msg"},{"t":"delete","p":"responseCookies","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":100,"wires":[["8e53928c.d9418"]]},{"id":"4366e719.59524","type":"change","z":"1c9d8fd6.7a925","name":"","rules":[{"t":"move","p":"payload.title[0]","pt":"msg","to":"title","tot":"msg"},{"t":"move","p":"payload.enclosure[0].$.url","pt":"msg","to":"url","tot":"msg"},{"t":"move","p":"payload.pubDate[0]","pt":"msg","to":"pubDate","tot":"msg"},{"t":"delete","p":"parts","pt":"msg"},{"t":"move","p":"payload","pt":"msg","to":"article","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":160,"wires":[["b3f2ba09.0de54"]]},{"id":"8bc56213.5c4b58","type":"function","z":"1c9d8fd6.7a925","name":"Set filename","func":"msg.filename = msg.title + \".mp3\";\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":160,"wires":[["3e5aa23b.54df7e"]]},{"id":"b3f2ba09.0de54","type":"function","z":"1c9d8fd6.7a925","name":"Only new articles","func":"const now = flow.lastDate || new Date(2020, 5, 1);\nconst pubDate = new Date(msg.pubDate);\n\nif (pubDate <= now) return null;\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":160,"wires":[["8bc56213.5c4b58"]]},{"id":"3e5aa23b.54df7e","type":"http request","z":"1c9d8fd6.7a925","name":"Request mp3","method":"GET","ret":"bin","paytoqs":false,"url":"","tls":"","persist":true,"proxy":"","authType":"","x":300,"y":220,"wires":[["2e0c376a.1ab878"]]},{"id":"887a5cbe.d39b78","type":"sftp in","z":"1c9d8fd6.7a925","name":"Send to Raktar","sftp":"e3f7555d.d32fa","operation":"put","filename":"","localFilename":"","workdir":"/sharedfolders/Music/Podcasts/Mike Ward Sous Ecoute/","x":740,"y":220,"wires":[["64b9184.69a8668"]]},{"id":"2e0c376a.1ab878","type":"change","z":"1c9d8fd6.7a925","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.data","tot":"msg"},{"t":"move","p":"filename","pt":"msg","to":"payload.filename","tot":"msg"},{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"},{"t":"set","p":"lastDate","pt":"flow","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":220,"wires":[["887a5cbe.d39b78"]]},{"id":"64b9184.69a8668","type":"debug","z":"1c9d8fd6.7a925","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":220,"wires":[]},{"id":"63d893f4.3e39a4","type":"inject","z":"2dbe54a8.332f04","name":"make request","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"","x":130,"y":40,"wires":[["56e08234.2801ec"]]},{"id":"8b96914.cfa247","type":"http request","z":"2dbe54a8.332f04","name":"/r/GameDeals","method":"GET","ret":"obj","paytoqs":true,"url":"https://www.reddit.com/r/GameDeals/new/.json","tls":"","persist":false,"proxy":"","authType":"","x":460,"y":120,"wires":[["9e2e2872.b3ceb8"]]},{"id":"9e2e2872.b3ceb8","type":"change","z":"2dbe54a8.332f04","name":"Set \"after\"","rules":[{"t":"set","p":"after","pt":"flow","to":"payload.data.after","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"msg.payload.data.children.data","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":250,"y":220,"wires":[["bdef534b.d33f5"]]},{"id":"bdef534b.d33f5","type":"split","z":"2dbe54a8.332f04","name":"Array to Posts","splt":"\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":460,"y":220,"wires":[["b638f8ab.91df1"]]},{"id":"56e08234.2801ec","type":"switch","z":"2dbe54a8.332f04","name":"","property":"after","propertyType":"flow","rules":[{"t":"istype","v":"undefined","vt":"undefined"},{"t":"nempty"}],"checkall":"false","repair":false,"outputs":2,"x":150,"y":120,"wires":[["aa4136b3.33324"],["27be5a79.0eb54e"]]},{"id":"27be5a79.0eb54e","type":"template","z":"2dbe54a8.332f04","name":"after","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{\n    \"after\": \"{{flow.after}}\",\n    \"limit\": 100\n}","output":"json","x":290,"y":140,"wires":[["8b96914.cfa247"]]},{"id":"aa4136b3.33324","type":"change","z":"2dbe54a8.332f04","name":"empty","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":100,"wires":[["8b96914.cfa247"]]},{"id":"b638f8ab.91df1","type":"change","z":"2dbe54a8.332f04","name":"Prepare posts","rules":[{"t":"move","p":"payload","pt":"msg","to":"old","tot":"msg"},{"t":"set","p":"payload.title","pt":"msg","to":"old.title","tot":"msg"},{"t":"set","p":"payload.url","pt":"msg","to":"old.url","tot":"msg"},{"t":"set","p":"payload.thumbnail","pt":"msg","to":"old.thumbnail","tot":"msg"},{"t":"move","p":"old","pt":"msg","to":"payload.old","tot":"msg"},{"t":"delete","p":"payload.old","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":220,"wires":[["a69e38fa.3590a8"]]},{"id":"a69e38fa.3590a8","type":"function","z":"2dbe54a8.332f04","name":"Set domain","func":"const re = /\\[.*\\]/\nmsg.payload.platform = msg.payload.title.match(re)[0].slice(1, -1);\n\nconst url = global.get('url');\nconst domain = url.parse(msg.payload.url);\nmsg.payload.domain = domain.hostname;\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":320,"wires":[["464634ef.8dbb2c"]]},{"id":"464634ef.8dbb2c","type":"function","z":"2dbe54a8.332f04","name":"Filter","func":"const platforms = [\n    \"Steam\",\n    \"Epic\",\n    \"Origin\",\n    \"Ubisoft\",\n    \"GoG\",\n    \"IndieGala\",\n    \"Humble\",\n\n]\n\nconst domains = [\n    \"store.steampowered.com\",\n    \"www.epicgames.com\",\n    \"www.gog.com\",\n    \"www.origin.com\",\n    \"freebies.indiegala.com\",\n    \"www.humblebundle.com\",\n    \"www.indiegala.com\",\n    \"store.ubi.com\",\n    \"ubisoft.com\",\n    \"www.wingamestore.com\",\n    \"www.reddit.com\"\n]\nlet pick = false;\n\nfor (const domain of domains) {\n    console.log(msg.payload.domain + \" === \" + domain);\n    if (msg.payload.domain === domain) {\n        pick = true;\n        break;\n    }\n}\nif (!pick) return null;\n\nlet re = /(free)|(100% off)/ig;\nif (msg.payload.title.search(re) == -1) return null;\n\nre = /(limited time)|(weekend)|(free to play)|(trial)|(buy)/ig;\nif (msg.payload.title.search(re) > -1) return null;\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":320,"wires":[["1b85bf46.53eef9"]]},{"id":"1b85bf46.53eef9","type":"debug","z":"2dbe54a8.332f04","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":690,"y":320,"wires":[]}]